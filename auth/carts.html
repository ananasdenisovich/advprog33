<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
</head>

<body>
    <h1>Shopping Cart</h1>

    <form id="cartForm">
        <label for="furnitureID">Furniture ID:</label>
        <input type="text" id="furnitureID" name="furnitureID" required><br>

        <label for="quantity">Quantity:</label>
        <input type="number" id="quantity" name="quantity" min="1" required><br>

        <button type="button" onclick="addToCart()">Add to Cart</button>
    </form>

    <div id="cartResponse"></div>

    <h1>User Carts</h1>
    <div id="userCarts"></div>
    <div id="cartsContainer"></div>

    <div id="paymentForm" style="display: none;">
        <h2>Enter Payment Details</h2>
        <form id="paymentDetailsForm">
            <label for="cardNumber">Card Number:</label>
            <input type="text" id="cardNumber" name="cardNumber" required><br>
    
            <label for="expiryDate">Expiry Date:</label>
            <input type="text" id="expiryDate" name="expiryDate" required><br>
    
            <label for="cvv">CVV:</label>
            <input type="text" id="cvv" name="cvv" required><br>
    
            <button type="button" onclick="confirmPayment()">Confirm Payment</button>
        </form>
    </div>

    <script>
       const token = localStorage.getItem('jwtToken');

function fetchUserCarts() {
    fetch('http://localhost:8080/user-carts', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(carts => {
        displayUserCarts(carts);
    })
    .catch(error => {
        console.error('Error fetching user carts:', error);
    });
}

function displayUserCarts(carts) {
    const userCartsDiv = document.getElementById('userCarts');
    userCartsDiv.innerHTML = '';

    carts.forEach(cart => {
        const cartDiv = document.createElement('div');
        cartDiv.innerHTML = `
            <p>Furniture ID: ${cart.furnitureID}</p>
            <p>Furniture Name: ${cart.furnitureName}</p>
            <p>Quantity: ${cart.quantity}</p>
            <p>Total Price: ${cart.totalPrice}</p>
            <p>Status: ${cart.status}</p>
            <button onclick="showPaymentForm('${cart.cartID}')">Pay Now</button>
            <hr>
        `;
        userCartsDiv.appendChild(cartDiv);
    });
}

function showPaymentForm(cartID) {
    document.getElementById('paymentForm').style.display = 'block';
    document.getElementById('paymentDetailsForm').dataset.cartID = cartID;
}


function confirmPayment() {
    const cartID = document.getElementById('paymentDetailsForm').dataset.cartID;
    const cardNumber = document.getElementById('cardNumber').value;
    const expiryDate = document.getElementById('expiryDate').value;
    const cvv = document.getElementById('cvv').value;

    const paymentDetails = {
        cartID: cartID,
        cardNumber: cardNumber,
        expiryDate: expiryDate,
        cvv: cvv,
    };

    fetch('http://localhost:8080/confirm-payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(paymentDetails)
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.message === 'Payment successful') {
            fetchUserCarts();  // Refresh carts
            document.getElementById('paymentForm').style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error confirming payment:', error);
    });
}

function addToCart() {
    const token = localStorage.getItem('jwtToken');
    const furnitureID = document.getElementById("furnitureID").value;
    const quantity = parseInt(document.getElementById("quantity").value); // Parse quantity as integer

    const cartItem = {
        furnitureID: furnitureID,
        quantity: quantity, // Ensure quantity is parsed as integer
    };

    fetch('http://localhost:8080/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(cartItem),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Cart Response:', data);
            // Handle response data as needed
        })
        .catch(error => {
            console.error('Error adding to cart:', error);
            // Handle error as needed
        });
}

fetchUserCarts();
</script>
</body>

</html>
