<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <title>Online Furniture Shop</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Forum&display=swap');

        body,
        button,
        input,
        textarea {
            font-family: 'Forum', serif;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="http://localhost:8080/">Terra Education</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link active" aria-current="page" href="http://localhost:8080/">Home</a>
                    <a class="nav-link" href="./Furniture.html">Furniture</a>
                    <a class="nav-link" href="./Profile.html">Profile</a>
                    <a class="nav-link" href="./Login.html">Login</a>
                    <a class="nav-link" href="./Register.html">Register</a>
                </div>
            </div>
        </div>
    </nav>
    <h1>Shopping Cart</h1>

    <form id="cartForm">
        <label for="furnitureID">Furniture ID:</label>
        <input type="text" id="furnitureID" name="furnitureID" required><br>

        <label for="quantity">Quantity:</label>
        <input type="number" id="quantity" name="quantity" min="1" required><br>

        <button type="button" onclick="addToCart()">Add to Cart</button>
    </form>

    <div id="cartResponse"></div>

    <h1>User Carts</h1>
    <div id="userCarts"></div>
    <div id="cartsContainer"></div>

    <div id="paymentForm" style="display: none;">
        <h2>Enter Payment Details</h2>
        <form id="paymentDetailsForm">
            <label for="cardNumber">Card Number:</label>
            <input type="text" id="cardNumber" name="cardNumber" required><br>
    
            <label for="expiryDate">Expiry Date:</label>
            <input type="text" id="expiryDate" name="expiryDate" required><br>
    
            <label for="cvv">CVV:</label>
            <input type="text" id="cvv" name="cvv" required><br>
    
            <button type="button" onclick="confirmPayment()">Confirm Payment</button>
        </form>
    </div>

    <script>
       const token = localStorage.getItem('jwtToken');

function fetchUserCarts() {
    fetch('http://localhost:8080/user-carts', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(carts => {
        displayUserCarts(carts);
    })
    .catch(error => {
        console.error('Error fetching user carts:', error);
    });
}

function displayUserCarts(carts) {
    const userCartsDiv = document.getElementById('userCarts');
    userCartsDiv.innerHTML = '';

    carts.forEach(cart => {
        const cartDiv = document.createElement('div');
        cartDiv.innerHTML = `
            <p>Furniture ID: ${cart.furnitureID}</p>
            <p>Furniture Name: ${cart.furnitureName}</p>
            <p>Quantity: ${cart.quantity}</p>
            <p>Total Price: ${cart.totalPrice}</p>
            <p>Status: ${cart.status}</p>
            <button onclick="showPaymentForm('${cart.cartID}')">Pay Now</button>
            <hr>
        `;
        userCartsDiv.appendChild(cartDiv);
    });
}

function showPaymentForm(cartID) {
    window.location.href = `http://localhost:8081/static/payment.html?cartID=${cartID}`;
}



function confirmPayment() {
    const cartID = document.getElementById('paymentDetailsForm').dataset.cartID;
    const cardNumber = document.getElementById('cardNumber').value;
    const expiryDate = document.getElementById('expiryDate').value;
    const cvv = document.getElementById('cvv').value;

    const paymentDetails = {
        cartID: cartID,
        cardNumber: cardNumber,
        expiryDate: expiryDate,
        cvv: cvv,
    };

    fetch('http://localhost:8080/confirm-payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(paymentDetails)
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.message === 'Payment successful') {
            fetchUserCarts();  // Refresh carts
            document.getElementById('paymentForm').style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error confirming payment:', error);
    });
}

function addToCart() {
    const token = localStorage.getItem('jwtToken');
    const furnitureID = document.getElementById("furnitureID").value;
    const quantity = parseInt(document.getElementById("quantity").value); 

    const cartItem = {
        furnitureID: furnitureID,
        quantity: quantity, 
    };

    fetch('http://localhost:8080/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(cartItem),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Cart Response:', data);

        })
        .catch(error => {
            console.error('Error adding to cart:', error);
        });
}

fetchUserCarts();
</script>
</body>

</html>
